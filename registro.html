<!DOCTYPE html>
<html>
<head>
  <title>Registro</title>
  <link rel="stylesheet" type="text/css" href="registro.css">
</head>
<body>
  <div class="popup-container">
    <div class="popup">
      <h1>Registro</h1>
      <label for="name">Nombre completo:</label>
      <input type="text" id="name" name="nombre_completo" placeholder="Ingresa tu nombre">

      <label for="email">Correo Electrónico:</label>
      <input type="email" id="email" placeholder="Ingresa tu correo electrónico">
      <span id="emailError" style="color: red;"></span>
      
      
      <label for="password">Contraseña:</label>
      <input type="password" id="password" placeholder="Ingresa tu contraseña">
      
      <label for="confirmPassword">Confirmar Contraseña:</label>
      <input type="password" id="confirmPassword" placeholder="Confirma tu contraseña">

      <label for="idDocument">Documento de Identidad:</label>
      <input type="text" id="idDocument" placeholder="Ingresa tu documento de identidad">

      <label for="gender">Sexo:</label>
      <select id="gender">
        <option value="masculino">Masculino</option>
        <option value="femenino">Femenino</option>
        <option value="otro">Otro</option>
      </select>
      
      <label for="birthdate">Fecha de Nacimiento:</label>
      <input type="date" id="birthdate">

      <label for="rolid">Rol:</label>
      <select id="rolid">
        
      </select>
      <span id="roleError" style="color: red;"></span>

    
      <button id="registerButton">Registrarse</button>
      <span class="close">&times;</span>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {

     
      const registerButton = document.getElementById('registerButton');

      
      registerButton.addEventListener('click', () => {

        const idDocument = document.getElementById('idDocument').value;
        
        const name = document.getElementById('name').value;
    
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const gender = document.getElementById('gender').value;
        const birthdate = document.getElementById('birthdate').value;
        const formattedBirthdate = new Date(birthdate).toISOString().split('T')[0];

        console.log('Fecha de nacimiento formateada:', formattedBirthdate);


        const idRol = document.getElementById('rolid').value;

        // Validación del correo electrónico
        if (!email.endsWith('@elpoli.edu.co')) {
          const emailError = document.getElementById('emailError');
          emailError.textContent = 'El correo electrónico debe ser del @elpoli.edu.co';
          return; 
        }

        

        // Si llegamos hasta aquí, el correo es válido, limpia cualquier mensaje de error previo
        const emailError = document.getElementById('emailError');
        emailError.textContent = '';

      
        const formData = new URLSearchParams();
        formData.append('documento_identidad', idDocument);
        formData.append('nombre_completo', name);
        formData.append('correo_electronico', email);
        formData.append('contrasena', password);
        formData.append('fecha_nacimiento', formattedBirthdate);
        formData.append('sexo', gender);
        formData.append('id_rol', idRol);
        

        // Realiza una solicitud POST al servidor Node.js
        fetch('/registro', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString() 
        })
        .then((response) => {
          if (response.ok) {
            
            alert('Registro exitoso');
            
            window.location.href = 'inicio';
          } else {
           
            alert('Error en el registro');
          }
        })
        .catch((error) => {
          console.error('Error al enviar la solicitud POST:', error);
        });

      });
    });



    // Función para cargar dinámicamente la lista de roles en el formulario de registro
function cargarListaRoles() {
    const selectRol = document.getElementById('rolid');

    fetch('/getListaRoles')
        .then(response => response.json())
        .then(data => {
           
            selectRol.innerHTML = '';

            // Agrega las nuevas opciones basadas en los datos recibidos del servidor
            data.forEach(rol => {
                const option = document.createElement('option');
                option.value = rol[0]; 
                option.textContent = rol[0] + ' - ' + rol[1]; 
                selectRol.appendChild(option);
            });
        })
        .catch(error => console.error('Error al cargar la lista de roles: ', error));
}

// Llama a la función para cargar roles en el formulario cuando la página se carga
document.addEventListener('DOMContentLoaded', function () {
    cargarListaRoles();
});

  </script>
</body>
</html>