<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <title>Gestion de Usuarios</title>
    <style>
        table {
            border-collapse: separate;
            border-spacing: 10px;
        }

        /* Clase para el botón de edición (color azul) */
        .btn-editar {
            background-color: #85b31b;
            color: white;
            padding: 5px 20px;
        }

        .btn-éxito {
            background-color: #85b31b;
            color: white;
            padding: 10px 20px;
        }

        .btn-primary {
            background-color: #85b31b;
            color: white;
            padding: 5px 2px;
        }

        .btn-primary:hover {
            background-color: #85b31b;
            color: white;
        }

        td {
            margin-bottom: 5px;
        }

        #asignarRolModal {
            margin-left: 10px;
            top: 30%;
        }

        .modal {
            max-width: 60%;
            margin: 0 auto;
        }

        .modal-content {
            margin: 10% auto;
            padding: 20px;
        }

        td button {
            margin-bottom: 5px;
        }


    </style>
    /* Estilo para el modal de edición */
    .modal {
        width: 80%;
    max-width: 400px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ccc;
    z-index: 1000;
    display: none;
    overflow-y: auto;
    }

    /* Estilo para el contenido del modal */
    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        width: 100%; 
        max-width: none; 
        border-radius: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    
       
    .modal.open {
        display: block;
    }

 
    .close {
        float: right;
        cursor: pointer;
        font-size: 20px;
        color: #333;
    }

   
    h2 {
        margin-top: 0;
    }

    /* Estilo para los campos de entrada y etiquetas en el formulario */
    .mb-3 {
        margin-bottom: 15px;
    }

    label {
        font-weight: bold;
    }

    input[type="text"],
    input[type="email"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    /* Estilo para el botón "Guardar Cambios" */
    .btn-success {
        background-color: #85b31b;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn-success:hover {
        background-color: #5a7f1d;
    }

    .fas{
        color:#333;
    }
</style>

    </style>
</head>

<body>
    <div class="container">
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-light" onclick="window.history.back();">
              <i class="fas fa-arrow-left"></i>
            </button>
            <h1>Lista de Usuarios</h1>
        </div>
        <table class="table table-striped">
            <tbody id="userTable">
            </tbody>
        </table>
        <div class="d-inline">
            <button class="btn btn-success" onclick="abrirFormulario()">Crear Nuevo Usuario</button>
            <button class="btn btn-editar" onclick="abrirModalEditarUsuario()">Editar</button>
            <button class="btn btn-primary" onclick="abrirAsignarRolForm()">Asignar Rol</button>
            <button class="btn btn-danger" onclick="abrirEliminarUsuarioForm()">Eliminar</button>
        </div>
        <!-- Formulario para crear un nuevo usuario (inicialmente oculto) -->
<div id="crearUsuarioForm" style="display: none;">
    <form>
        <div class="mb-3">
            <label for="idDocument" class="form-label">Documento de Identidad:</label>
            <input type="text" id="idDocument" class="form-control">
        </div>
        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre:</label>
            <input type="text" id="nombre" class="form-control">
        </div>
        <div class="mb-3">
            <label for="correoElectronico" class="form-label">Correo Electrónico:</label>
            <input type="email" id="correoElectronico" class="form-control">
        </div>
        <div class="mb-3">
            <label for="contrasena" class="form-label">Contraseña:</label>
            <input type="password" id="contrasena" class="form-control">
        </div>
        <div class="mb-3">
            <label for="contrasenaconfi" class="form-label">Confirmar Contraseña:</label>
            <input type="password" id="contrasenaconfi" class="form-control">
        </div>
        <div class="mb-3">
            <label for="genero" class="form-label">Género:</label>
            <select id="genero" class="form-select">
                <option value="masculino">Masculino</option>
                <option value="femenino">Femenino</option>
                <option value="otro">Otro</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento:</label>
            <input type="date" id="fechaNacimiento" class="form-control">
        </div>

        <label for="rolid">Rol:</label>
        <select id="rolid">
        
        </select>
        <span id="roleError" style="color: red;"></span>

        <button type="button" class="btn btn-success" onclick="crearUsuario()">Crear Usuario</button>
        <button type="button" class="btn btn-secondary" id="cancelarBtn" onclick="cancelarCreacion()">Cancelar</button>
    </form>
</div>

<!-- Modal asignar rol -->
<div id="asignarRolModal" class="modal draggable">
    <div class="modal-content">
        <span id="cerrarModal" class="close">×</span>
        <h2>Asignar Rol</h2>
        <form>
            <div class="mb-3">
                <label for="selectUsuario">Seleccionar Usuario:</label>
                <select id="selectUsuario" class="form-control">
             
                </select>
            </div>
            <div class="mb-3">
                <label for="selectRol">Seleccionar Rol:</label>
                <select id="selectRol" class="form-control">
                    
                </select>
            </div>
            <div class="mb-3">
                <label for="nuevoEstado">Nuevo Estado:</label>
                <input type="text" id="nuevoEstado" class="form-control">
            </div>
            <button type="button" class="btn btn-success" onclick="asignarRol()">Asignar Rol</button>
        </form>
    </div>
</div>

<!-- Modal para elegir que usuario editar-->

<div id="seleccionarUsuarioModal" class="modal draggable">
    <div class="modal-content">
        <span id="cerrarModalSeleccionarUsuario" class="close">&times;</span>
        <h2>Seleccionar Usuario</h2>
        <form>
            <div class="mb-3">
                <label for="selectUsuarioEditar">Seleccionar Usuario:</label>
                <select id="selectUsuarioEditar" class="form-control">
                </select>
            </div>
            <button type="button" class="btn btn-primary" onclick="abrirModalEditarDetalles()">Editar</button>
        </form>
    </div>
</div>

<!-- Modal para editar usuario -->
<div id="editarUsuarioModal" class="modal draggable">
    <div class="modal-content">
        <span id="cerrarModalEditar" class="close">&times;</span>
        <h2>Editar Usuario</h2>
        <form>
            <div class="mb-3">
                <label for="documentoIdentidadUsuario">Documento de Identidad:</label>
                <input type="text" id="documentoIdentidadUsuario" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label for="nombreCompletoUsuario">Nombre Completo:</label>
                <input type="text" id="nombreCompletoUsuario" class="form-control">
            </div>
            <div class="mb-3">
                <label for="correoElectronicoUsuario">Correo Electrónico:</label>
                <input type="email" id="correoElectronicoUsuario" class="form-control">
            </div>
            <div class="mb-3">
                <label for="contrasenaUsuario">Contraseña:</label>
                <input type="password" id="contrasenaUsuario" class="form-control">
            </div>
            <div class="mb-3">
                <label for="fechaNacimientoUsuario">Fecha de Nacimiento:</label>
                <input type="date" id="fechaNacimientoUsuario" class="form-control">
            </div>
            <div class="mb-3">
                <label for="sexoUsuario">Sexo:</label>
                <input type="text" id="sexoUsuario" class="form-control">
            </div>
            <div class="mb-3">
                <label for="idRolUsuario">ID Rol:</label>
                <input type="number" id="idRolUsuario" class="form-control">
            </div>
            <button type="button" class="btn btn-primary" onclick="guardarCambiosUsuario()">Guardar Cambios</button>
        </form>
    </div>
</div>





    <!-- Modal para eliminar usuario -->
<div id="eliminarUsuarioModal" class="modal draggable">
    <div class="modal-content">
        <span id="cerrarModalEliminar" class="close">&times;</span>
        <h2>Eliminar Usuario</h2>
        <form>
            <div class="mb-3">
                <label for="selectUsuarioEliminar">Seleccionar Usuario:</label>
                <select id="selectUsuarioEliminar" class="form-control">
             
                </select>
            </div>
            <button type="button" class="btn btn-danger" onclick="eliminarUsuarioConfirmar()">Eliminar</button>
        </form>
    </div>
</div>







    <h2>Historial de actividades</h2>
    <ul id="activityLog" class="list-group">
   
    </ul>
</body>

<script>
    function crearUsuario() {
        const idDocument = document.getElementById('idDocument').value;
        const nombre = document.getElementById('nombre').value;
        const correoElectronico = document.getElementById('correoElectronico').value;
        const contrasena = document.getElementById('contrasena').value;
        const genero = document.getElementById('genero').value;
        const fechaNacimiento = document.getElementById('fechaNacimiento').value;
        const formattedBirthdate = new Date(fechaNacimiento).toISOString().split('T')[0];
        const idRol = document.getElementById('rolid').value;
        const formData = new URLSearchParams();
        formData.append('documento_identidad', idDocument);
        formData.append('nombre_completo', nombre);
        formData.append('correo_electronico', correoElectronico);
        formData.append('contrasena', contrasena);
        formData.append('fecha_nacimiento', formattedBirthdate);
        formData.append('sexo', genero);
        formData.append('id_rol', idRol);
        // Realiza una solicitud POST al servidor Node.js
        fetch('/gestion_u', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData.toString(), 
        })
        .then((response) => {
            if (response.ok) {
                alert('Registro exitoso');
            } else {
                alert('Error en el registro');
            }
        })
        .catch((error) => {
            console.error('Error al enviar la solicitud POST:', error);
        });
    }

    function cargarUsuarios() {
        // Realiza una solicitud AJAX para obtener la lista de usuarios en formato HTML
        fetch('/getUsuarios')
        .then(response => response.text())
        .then(data => {
            
            const userTable = document.getElementById('userTable');
            userTable.innerHTML = data;

            
        })
        .catch(error => console.error('Error al cargar la lista de usuarios: ', error));
    }

    // Llama a la función para cargar usuarios cuando la página se carga
    document.addEventListener('DOMContentLoaded', cargarUsuarios);

    function cancelarCreacion() {
        // Ocultar el formulario para crear un nuevo usuario
        document.getElementById('crearUsuarioForm').style.display = 'none';
       
        document.getElementById('idDocument').value = '';
        document.getElementById('nombre').value = '';
    
       
        document.getElementById('correoElectronico').value = '';
        document.getElementById('contrasena').value = '';
        document.getElementById('genero').value = 'masculino'; 
        document.getElementById('fechaNacimiento').value = '';
     
    }

    function abrirFormulario() {
        // Mostrar el formulario para crear un nuevo usuario
        document.getElementById('crearUsuarioForm').style.display = 'block';
    }

    function abrirAsignarRolForm() {
       
        const modal = document.getElementById('asignarRolModal');
        const closeButton = document.getElementById('cerrarModal');

       
        modal.style.display = 'block';

        
        closeButton.onclick = function () {
            modal.style.display = 'none';
        }

    
        window.onclick = function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
         cargarSolicitudesCambioRol();
        cargarRolesDisponibles();
    }

        // Función para cargar dinámicamente la lista de solicitudes de cambio de rol
    function cargarSolicitudesCambioRol() {
        const selectUsuario = document.getElementById('selectUsuario');
    
        fetch('/getSolicitudesCambioRol')
            .then(response => response.json())
            .then(data => {
                selectUsuario.innerHTML = '';
                data.forEach(solicitud => {
                    const option = document.createElement('option');
                    option.value = solicitud.id_solicitud;
                    option.textContent = `Usuario: ${solicitud.nombre_completo}, Estado: ${solicitud.estado}, Rol Solicitado: ${solicitud.id_rol_solicitado}`;
                    selectUsuario.appendChild(option);
                });
            })
            .catch(error => console.error('Error al cargar la lista de solicitudes: ', error));
    }

    
    function cargarRolesDisponibles() {
        const selectRol = document.getElementById('selectRol');
    
        fetch('/getRolesDisponibles')
            .then(response => response.json())
            .then(data => {
                selectRol.innerHTML = '';
                data.forEach(rol => {
                    const option = document.createElement('option');
                    option.value = rol.id_rol;
                    option.textContent = rol.nombre_rol;
                    selectRol.appendChild(option);
                });
            })
            .catch(error => console.error('Error al cargar la lista de roles: ', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        cargarRolesDisponibles();
        cargarSolicitudesCambioRol();
    });












    // Función para cargar dinámicamente la lista de usuarios en el modal
    function cargarListaUsuarios() {
        const selectUsuario = document.getElementById('selectUsuario');
        fetch('/getListaUsuarios')
            .then(response => response.json())
            .then(data => {
             
                selectUsuario.innerHTML = '';
            
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user[0]; 
                    option.textContent = user[0] + ' - ' + user[1]; 
                    selectUsuario.appendChild(option);
                });
            })
            .catch(error => console.error('Error al cargar la lista de usuarios: ', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        cargarListaUsuarios();
    });















    function asignarRol() {
    // Obtener el documento_identidad, el nuevo rol, y el nuevo estado especificado
    const selectUsuario = document.getElementById('selectUsuario');
    const selectRol = document.getElementById('selectRol');
    const nuevoEstadoInput = document.getElementById('nuevoEstado');
    const idSolicitud = selectUsuario.value;
    const nuevoRol = selectRol.value;
    const nuevoEstado = nuevoEstadoInput.value;

   
    if (!idSolicitud || !nuevoRol || !nuevoEstado) {
        alert('Por favor, seleccione un usuario, un nuevo rol y especifique un nuevo estado.');
        return;
    }

    // Realizar una solicitud AJAX al servidor para actualizar el estado en la tabla solicitudes_cambio_rol
    fetch('/actualizarEstadoRol', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ idSolicitud, nuevoEstado })
    })
    .then(response => response.text())
    .then(data => {
        
        alert(data);
    })
    .catch(error => console.error('Error al actualizar el estado: ', error));


    fetch('/actualizarNuevoRol', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ idSolicitud, nuevoRol })
    })
    .then(response => response.text())
    .then(data => {
        
        alert(data);
    })
    .catch(error => console.error('Error al actualizar el nuevo rol: ', error));
}

    

   

    function abrirEliminarUsuarioForm() {
        const modal = document.getElementById('eliminarUsuarioModal');
        modal.style.display = 'block';
    }



    // Función para cargar dinámicamente la lista de usuarios en el modal de eliminar
function cargarListaUsuariosEliminar() {
    const selectUsuarioEliminar = document.getElementById('selectUsuarioEliminar');

    // Realiza una solicitud AJAX para obtener la lista de usuarios en formato JSON
    fetch('/getListaUsuariosEliminar')
        .then(response => response.json())
        .then(data => {
          
            selectUsuarioEliminar.innerHTML = '';

            
            data.forEach(user => {
                const option = document.createElement('option');
                option.value = user[0]; 
                option.textContent = user[0] + ' - ' + user[1]; 
                selectUsuarioEliminar.appendChild(option);
            });
        })
        .catch(error => console.error('Error al cargar la lista de usuarios: ', error));
}

// Llama a la función para cargar usuarios en el modal cuando la página se carga
document.addEventListener('DOMContentLoaded', function () {
    cargarListaUsuariosEliminar();
});





// Función para eliminar un usuario
function eliminarUsuarioConfirmar() {
    const selectUsuarioEliminar = document.getElementById('selectUsuarioEliminar');
    const selectedValue = selectUsuarioEliminar.value;
    if (!selectedValue) {
        alert('Debes seleccionar un usuario a eliminar.');
        return;
    }

    const [documento, nombre] = selectedValue.split(' - ');

    fetch('/eliminarUsuario', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            documento: documento,
            nombre: nombre,
        }),
    })
    .then((response) => {
        if (response.ok) {
            alert('Usuario eliminado exitosamente.');
            cargarListaUsuariosEliminar(); 
        } else {
            alert('Error al eliminar el usuario.');
        }
    })
    .catch((error) => {
        console.error('Error al enviar la solicitud POST:', error);
    });
}





// Obtén una lista de todos los elementos con la clase "close"
const closeButtons = document.getElementsByClassName("close");


for (const closeButton of closeButtons) {
    closeButton.addEventListener("click", function () {
        
        const modal = this.closest(".modal");
        if (modal) {
            modal.style.display = "none"; 
        }
    });
}


window.addEventListener("click", function (event) {
  
    if (event.target.classList.contains("modal")) {
        event.target.style.display = "none";
    }
});


const draggableModals = document.querySelectorAll(".draggable");


let isDragging = false;
let modalOffsetX, modalOffsetY;


draggableModals.forEach((modal) => {
   
    modal.addEventListener("mousedown", (e) => {
        isDragging = true;

        
        modalOffsetX = e.clientX - modal.getBoundingClientRect().left;
        modalOffsetY = e.clientY - modal.getBoundingClientRect().top;
    });

  
    modal.addEventListener("mouseup", () => {
        isDragging = false;
    });

 
    modal.addEventListener("mousemove", (e) => {
        if (isDragging) {
            
            const newLeft = e.clientX - modalOffsetX;
            const newTop = e.clientY - modalOffsetY;

           
            modal.style.left = newLeft + "px";
            modal.style.top = newTop + "px";
        }
    });
});

  // Función para cargar dinámicamente la lista de roles en el formulario de registro
  function cargarListaRoles() {
    const selectRol = document.getElementById('rolid');

    fetch('/getListaRoles')
        .then(response => response.json())
        .then(data => {
          
            selectRol.innerHTML = '';

           
            data.forEach(rol => {
                const option = document.createElement('option');
                option.value = rol[0]; 
                option.textContent = rol[0] + ' - ' + rol[1]; 
                selectRol.appendChild(option);
            });
        })
        .catch(error => console.error('Error al cargar la lista de roles: ', error));
}

// Llama a la función para cargar roles en el formulario cuando la página se carga
document.addEventListener('DOMContentLoaded', function () {
    cargarListaRoles();
});


//------------------------------------------------------------------------------------------------------------

function abrirModalEditarUsuario() {
    const seleccionarUsuarioModal = document.getElementById('seleccionarUsuarioModal');
    seleccionarUsuarioModal.style.display = 'block';
}

function cargarListaUsuariosEditar() {
    const selectUsuarioEditar = document.getElementById('selectUsuarioEditar');

    // Realiza una solicitud AJAX para obtener la lista de usuarios en formato JSON
    fetch('/getListaUsuariosEditar')
        .then(response => response.json())
        .then(data => {
         
            selectUsuarioEditar.innerHTML = '';

        
            data.forEach(user => {
                const option = document.createElement('option');
                option.value = user.documento_identidad; 
                option.textContent = user.documento_identidad + ' - ' + user.nombre_completo; 
                selectUsuarioEditar.appendChild(option);
            });
        })
        .catch(error => console.error('Error al cargar la lista de usuarios: ', error));
}


// Llama a la función para cargar usuarios en el modal de selección cuando se carga la página
document.addEventListener('DOMContentLoaded', function () {
    cargarListaUsuariosEditar();
});

function abrirModalEditarDetalles() {
    const editarUsuarioModal = document.getElementById('editarUsuarioModal');
    editarUsuarioModal.style.display = 'block';

    
    const documentoIdentidad = document.getElementById('selectUsuarioEditar').value;

    // Realiza una solicitud AJAX para obtener los detalles del usuario por su documento_identidad
    fetch('/getDetallesUsuario?documentoIdentidad=' + documentoIdentidad)
        .then(response => response.json())
        .then(data => {
            
            document.getElementById('documentoIdentidadUsuario').value = data.documento_identidad;
            document.getElementById('nombreCompletoUsuario').value = data.nombre_completo;
            document.getElementById('correoElectronicoUsuario').value = data.correo_electronico;
            document.getElementById('contrasenaUsuario').value = data.contrasena;
            const fechaFormateada = new Date(data.fecha_nacimiento).toISOString().split('T')[0];
            document.getElementById('fechaNacimientoUsuario').value = fechaFormateada;
            document.getElementById('sexoUsuario').value = data.sexo;
            document.getElementById('idRolUsuario').value = data.id_rol;
        })
        .catch(error => console.error('Error al cargar los detalles del usuario: ', error));
}


function guardarCambiosUsuario() {
    // Obtén los valores de los campos de edición en la modal
    const documentoIdentidad = document.getElementById('documentoIdentidadUsuario').value;
    const nombre = document.getElementById('nombreCompletoUsuario').value;
    const email = document.getElementById('correoElectronicoUsuario').value;
    const contrasena = document.getElementById('contrasenaUsuario').value;
    const fechaNacimiento = document.getElementById('fechaNacimientoUsuario').value;
    const fechaFormateada = new Date(fechaNacimiento).toISOString().split('T')[0];
    const sexo = document.getElementById('sexoUsuario').value;
    const idRol = document.getElementById('idRolUsuario').value;

    
    const datosUsuario = {
        documentoIdentidad: documentoIdentidad,
        nombre: nombre,
        email: email,
        contrasena: contrasena,
        fechaNacimiento: fechaFormateada,
        sexo: sexo,
        idRol: idRol
      
    };

   
    fetch('/actualizarUsuario', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosUsuario),
    })
        .then(response => response.json())
        .then(data => {
          
            if (data.success) {
                alert('Cambios guardados con éxito');
            } else {
                //alert('Error al guardar cambios');
            }
        })
        .catch(error => console.error('Error al guardar los cambios del usuario: ', error));
}




   
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</html>